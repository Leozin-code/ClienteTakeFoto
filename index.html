<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Captura de Foto AutomÃ¡tica / Modo Administrador</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background-color: #222; color: #eee; }
        h1 { color: #4CAF50; }
        #app-container { max-width: 800px; margin: 0 auto; }
        #capture-view { text-align: center; padding-top: 50px; }
        #admin-view { display: none; }
        #history-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        #history-table th, #history-table td { border: 1px solid #444; padding: 10px; text-align: left; }
        #history-table th { background-color: #333; cursor: pointer; }
        #history-table tr:hover { background-color: #555; }
        .active-row { background-color: #007bff !important; color: white; }
        #photo-display { margin-top: 40px; text-align: center; }
        #photo-display img { max-width: 100%; border: 3px solid #ccc; display: none; }
        #status-message { color: yellow; font-weight: bold; margin-bottom: 10px; }
        #redirect-status { display:none; }
        #redirect-timer { font-size: 1.2em; color: orange; }
    </style>
</head>
<body>

    <div id="app-container">
        <div id="capture-view">
            <h1>ðŸ“¸ Capturando Imagem...</h1>
            <p id="status-message">Aguardando... Pressione **Ctrl** para acesso rÃ¡pido.</p> 
            <p id="redirect-status">VocÃª serÃ¡ redirecionado em <span id="redirect-timer">5</span> segundos.</p>
        </div>

        <div id="admin-view">
            <h1>ðŸ”’ Modo Administrador - HistÃ³rico Local</h1>
            <p>As fotos abaixo foram salvas **neste navegador** (Local Storage).</p>
            
            <div id="photo-display">
                <h2>ðŸ“· Foto Selecionada</h2>
                <p id="selected-ip-text">Clique em uma linha para ver a foto.</p>
                <img id="selected-photo" src="" alt="Foto Capturada">
            </div>

            <table id="history-table">
                <thead>
                    <tr>
                        <th>EndereÃ§o IP (Clique para Ver)</th>
                        <th>Hora da Captura (Local)</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
        </div>
    </div>
    
    <video id="webcam-video" autoplay playsinline muted style="display: none;"></video>
    <canvas id="canvas" style="display: none;"></canvas>

    <script>
        // ==========================================================
        // VARIÃVEIS E CONSTANTES
        // ==========================================================
        const REDIRECT_URL = 'https://www.google.com';
        const STORAGE_KEY = 'photoHistory';
        const REDIRECT_TIME_SECONDS = 5;
        const DATA_PREFIX = 'data:image/png;base64,'; // Prefixo completo para exibiÃ§Ã£o

        const video = document.getElementById('webcam-video');
        const canvas = document.getElementById('canvas');
        const context = canvas.getContext('2d');
        const captureView = document.getElementById('capture-view');
        const adminView = document.getElementById('admin-view');
        const statusMessage = document.getElementById('status-message');
        const redirectStatus = document.getElementById('redirect-status');
        const redirectTimerSpan = document.getElementById('redirect-timer');
        const tableBody = document.querySelector('#history-table tbody');
        const selectedPhoto = document.getElementById('selected-photo');
        const selectedIpText = document.getElementById('selected-ip-text');

        let photoData = null;
        let userIP = 'IP_NAO_ENCONTRADO';
        let webcamStream = null;
        let redirectCountdownId = null;
        let historyData = [];
        let isInAdminMode = false;

        // ==========================================================
        // FUNÃ‡Ã•ES DE ADMINISTRAÃ‡ÃƒO
        // ==========================================================
        
        function loadHistory() {
            const storedData = localStorage.getItem(STORAGE_KEY);
            if (storedData) {
                historyData = JSON.parse(storedData);
            }
        }
        
        function saveHistory() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(historyData));
        }

        // ðŸŸ¢ REFORÃ‡O CRÃTICO: Garantir que a imagem seja um Data URI completo
        function displayPhoto(base64Img) {
             // Se o prefixo estiver faltando, a imagem salva estÃ¡ apenas como Base64 cru.
             // Adicionamos o prefixo DATA_PREFIX na frente.
            if (base64Img && !base64Img.startsWith(DATA_PREFIX)) {
                base64Img = DATA_PREFIX + base64Img;
            }
            
            selectedPhoto.src = base64Img;
            selectedPhoto.style.display = 'block';
        }

        function renderTable(selectedIndex = -1) {
            tableBody.innerHTML = ''; 
            
            historyData.slice().reverse().forEach((item, index) => {
                const originalIndex = historyData.length - 1 - index; 
                const row = tableBody.insertRow();
                
                row.classList.toggle('active-row', originalIndex === selectedIndex);

                row.insertCell().textContent = item.ip;
                row.insertCell().textContent = new Date(item.timestamp).toLocaleString();
                
                row.onclick = () => {
                    document.querySelectorAll('#history-table tr').forEach(r => r.classList.remove('active-row'));
                    row.classList.add('active-row');
                    
                    selectedIpText.textContent = `Foto de: ${item.ip}`;
                    displayPhoto(item.img);
                };
            });
        }
        
        function enterAdminMode() {
            if (isInAdminMode) return;

            isInAdminMode = true; 

            if (redirectCountdownId) {
                clearInterval(redirectCountdownId); 
            }
            if (webcamStream) {
                webcamStream.getTracks().forEach(track => track.stop()); 
            }
            
            loadHistory();
            renderTable();

            captureView.style.display = 'none';
            adminView.style.display = 'block';
            document.title = "Modo Administrador";
            console.log("Modo Administrador Ativado!");
        }

        // ==========================================================
        // FLUXO DE CAPTURA
        // ==========================================================

        function fetchUserIP() {
            return fetch('https://api.ipify.org?format=json')
                .then(response => response.json())
                .then(data => { userIP = data.ip; })
                .catch(() => { userIP = 'IP_NAO_ENCONTRADO'; });
        }
        
        function startWebcam() {
            return navigator.mediaDevices.getUserMedia({ video: { width: 320, height: 240 } })
                .then(stream => {
                    webcamStream = stream;
                    video.srcObject = stream;
                    return new Promise(resolve => video.onloadedmetadata = resolve);
                });
        }
        
        // ðŸŸ¢ REFORÃ‡O CRÃTICO: Salvando APENAS o dado Base64 (sem o prefixo) para manter a consistÃªncia com a funÃ§Ã£o displayPhoto
        function takePhoto() {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            // Salva apenas o Base64 sem o cabeÃ§alho 'data:image/png;base64,'
            photoData = canvas.toDataURL('image/png').split(',')[1]; 
        }

        function saveAndRedirect() {
            if (photoData) {
                const newItem = {
                    ip: userIP,
                    img: photoData, // img Ã© APENAS a string Base64
                    timestamp: new Date().toISOString()
                };
                
                loadHistory(); 
                historyData.push(newItem); 
                saveHistory(); 
            }
            
            statusMessage.style.display = 'none';
            redirectStatus.style.display = 'block';

            let timeLeft = REDIRECT_TIME_SECONDS;
            redirectTimerSpan.textContent = timeLeft;

            const countdown = setInterval(() => {
                if (isInAdminMode) {
                    clearInterval(countdown);
                    return;
                }

                timeLeft--;
                redirectTimerSpan.textContent = timeLeft;

                if (timeLeft <= 0) {
                    clearInterval(countdown);
                    window.location.href = REDIRECT_URL;
                }
            }, 1000);

            redirectCountdownId = countdown; 
        }

        // ==========================================================
        // INICIALIZAÃ‡ÃƒO E CONTROLE DE TECLAS
        // ==========================================================
        
        window.addEventListener('keydown', (e) => {
            if (e.key === 'Control') {
                e.preventDefault(); 
                enterAdminMode();
            }
        });

        async function runCaptureFlow() {
            // ðŸ›‘ VERIFICAÃ‡ÃƒO CRÃTICA (Ctrl pressionado no load)
            if (window.event && window.event.ctrlKey) {
                enterAdminMode();
                return;
            }
            
            // Garante que a visualizaÃ§Ã£o do timer esteja oculta no inÃ­cio
            redirectStatus.style.display = 'none'; 
            statusMessage.style.display = 'block';

            if (isInAdminMode) return; 

            statusMessage.textContent = "Iniciando captura de IP e cÃ¢mera...";

            await fetchUserIP();
            
            try {
                await startWebcam();
                statusMessage.textContent = "CÃ¢mera ativa. Capturando foto e salvando...";
                takePhoto();
                saveAndRedirect();
                
            } catch (e) {
                console.error("Erro na captura:", e);
                statusMessage.textContent = "Falha ao acessar a cÃ¢mera. Redirecionando...";
                
                setTimeout(() => {
                    if (!isInAdminMode) {
                         window.location.href = REDIRECT_URL;
                    }
                }, 2000);
            }
        }
        
        window.onload = runCaptureFlow;
    </script>
</body>
</html>
